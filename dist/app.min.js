((t,e)=>{"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.d3=t.d3||{})})(this,function(b){function E(t,e){return t<e?-1:e<t?1:e<=t?0:NaN}var D,U;1===(D=E).length&&(U=D,D=function(t,e){return E(U(t),e)});function A(t){for(var e,n,r,i=t.length,o=-1,a=0;++o<i;)a+=t[o].length;for(n=new Array(a);0<=--i;)for(e=(r=t[i]).length;0<=--e;)n[--a]=r[e];return n}function q(t,e){var n,r=0,i=t.length,o=-1;if(null==e)for(;++o<i;)(n=+t[o])&&(r+=n);else for(;++o<i;)(n=+e(t[o],o,t))&&(r+=n);return r}function t(){return new e}function e(){this.reset()}e.prototype={constructor:e,reset:function(){this.s=this.t=0},add:function(t){z(n,t,this.t),z(this,n.s,this.s),this.s?this.t+=n.t:this.s=n.t},valueOf:function(){return this.s}};var n=new e;function z(t,e,n){var r=t.s=e+n,i=r-e;t.t=e-(r-i)+(n-i)}var B=1e-6,_=Math.PI,g=_/2,V=_/4,O=2*_,F=180/_,L=_/180,j=Math.abs,G=Math.atan,k=Math.atan2,M=Math.cos,P=Math.sin,H=Math.sign||function(t){return 0<t?1:t<0?-1:0},I=Math.sqrt;function R(t){return 1<t?g:t<-1?-g:Math.asin(t)}function r(){}function o(t,e){t&&K.hasOwnProperty(t.type)&&K[t.type](t,e)}var W={Feature:function(t,e){o(t.geometry,e)},FeatureCollection:function(t,e){for(var n=t.features,r=-1,i=n.length;++r<i;)o(n[r].geometry,e)}},K={Sphere:function(t,e){e.sphere()},Point:function(t,e){t=t.coordinates,e.point(t[0],t[1],t[2])},MultiPoint:function(t,e){for(var n=t.coordinates,r=-1,i=n.length;++r<i;)t=n[r],e.point(t[0],t[1],t[2])},LineString:function(t,e){Y(t.coordinates,e,0)},MultiLineString:function(t,e){for(var n=t.coordinates,r=-1,i=n.length;++r<i;)Y(n[r],e,0)},Polygon:function(t,e){Z(t.coordinates,e)},MultiPolygon:function(t,e){for(var n=t.coordinates,r=-1,i=n.length;++r<i;)Z(n[r],e)},GeometryCollection:function(t,e){for(var n=t.geometries,r=-1,i=n.length;++r<i;)o(n[r],e)}};function Y(t,e,n){var r,i=-1,o=t.length-n;for(e.lineStart();++i<o;)r=t[i],e.point(r[0],r[1],r[2]);e.lineEnd()}function Z(t,e){var n=-1,r=t.length;for(e.polygonStart();++n<r;)Y(t[n],e,1);e.polygonEnd()}function l(t,e){t&&W.hasOwnProperty(t.type)?W[t.type](t,e):o(t,e)}t(),t();function X(t){return[k(t[1],t[0]),R(t[2])]}function T(t){var e=t[0],t=t[1],n=M(t);return[n*M(e),n*P(e),P(t)]}function S(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function N(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function J(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]}function w(t,e){return[t[0]*e,t[1]*e,t[2]*e]}function Q(t){var e=I(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=e,t[1]/=e,t[2]/=e}t();function $(n,r){function t(t,e){return t=n(t,e),r(t[0],t[1])}return n.invert&&r.invert&&(t.invert=function(t,e){return(t=r.invert(t,e))&&n.invert(t[0],t[1])}),t}function tt(t,e){return[_<t?t-O:t<-_?t+O:t,e]}function et(n){return function(t,e){return[_<(t+=n)?t-O:t<-_?t+O:t,e]}}function nt(t){var e=et(t);return e.invert=et(-t),e}function rt(t,e){var i=M(t),o=P(t),a=M(e),l=P(e);function n(t,e){var n=M(e),r=M(t)*n,t=P(t)*n,n=P(e),e=n*i+r*o;return[k(t*a-e*l,r*i-n*o),R(e*a+t*l)]}return n.invert=function(t,e){var n=M(e),r=M(t)*n,t=P(t)*n,n=P(e),e=n*a-t*l;return[k(t*a+n*l,r*i+e*o),R(e*i-r*o)]},n}function it(t,e){(e=T(e))[0]-=t,Q(e);t=1<(t=-e[1])?0:t<-1?_:Math.acos(t);return((-e[2]<0?-t:t)+O-B)%O}function ot(){var n,e=[];return{point:function(t,e){n.push([t,e])},lineStart:function(){e.push(n=[])},lineEnd:r,rejoin:function(){1<e.length&&e.push(e.pop().concat(e.shift()))},result:function(){var t=e;return e=[],n=null,t}}}function at(t,e){return j(t[0]-e[0])<B&&j(t[1]-e[1])<B}function lt(t,e,n,r){this.x=t,this.z=e,this.o=n,this.e=r,this.v=!1,this.n=this.p=null}function ut(t,e,n,r,o){var a,i,l=[],u=[];if(t.forEach(function(t){if(!((e=t.length-1)<=0)){var e,n,r=t[0],i=t[e];if(at(r,i)){for(o.lineStart(),a=0;a<e;++a)o.point((r=t[a])[0],r[1]);o.lineEnd()}else l.push(n=new lt(r,t,null,!0)),u.push(n.o=new lt(r,null,n,!1)),l.push(n=new lt(i,t,null,!1)),u.push(n.o=new lt(i,null,n,!0))}}),l.length){for(u.sort(e),st(l),st(u),a=0,i=u.length;a<i;++a)u[a].e=n=!n;for(var s,c,d=l[0];;){for(var f=d,p=!0;f.v;)if((f=f.n)===d)return;s=f.z,o.lineStart();do{if(f.v=f.o.v=!0,f.e){if(p)for(a=0,i=s.length;a<i;++a)o.point((c=s[a])[0],c[1]);else r(f.x,f.n.x,1,o);f=f.n}else{if(p)for(s=f.p.z,a=s.length-1;0<=a;--a)o.point((c=s[a])[0],c[1]);else r(f.x,f.p.x,-1,o);f=f.p}}while(s=(f=f.o).z,p=!p,!f.v);o.lineEnd()}}}function st(t){if(e=t.length){for(var e,n,r=0,i=t[0];++r<e;)i.n=n=t[r],n.p=i,i=n;i.n=n=t[0],n.p=i}}tt.invert=tt;var C=1e9,ct=-C;function dt(m,y,S,w){function x(t,e){return m<=t&&t<=S&&y<=e&&e<=w}function b(t,e,n,r){var i=0,o=0;if(null==t||(i=a(t,n))!==(o=a(e,n))||l(t,e)<0^0<n)for(;r.point(0===i||3===i?m:S,1<i?w:y),(i=(i+n+4)%4)!==o;);else r.point(e[0],e[1])}function a(t,e){return j(t[0]-m)<B?0<e?0:3:j(t[0]-S)<B?0<e?2:1:j(t[1]-y)<B?0<e?1:0:0<e?3:2}function E(t,e){return l(t.x,e.x)}function l(t,e){var n=a(t,1),r=a(e,1);return n!==r?n-r:0===n?e[1]-t[1]:1===n?t[0]-e[0]:2===n?t[1]-e[1]:e[0]-t[0]}return function(r){var i,d,o,a,l,u,s,c,f,p,g,h=r,t=ot(),e={point:n,lineStart:function(){e.point=v,d&&d.push(o=[]);p=!0,f=!1,s=c=NaN},lineEnd:function(){i&&(v(a,l),u&&f&&t.rejoin(),i.push(t.result()));e.point=n,f&&h.lineEnd()},polygonStart:function(){h=t,i=[],d=[],g=!0},polygonEnd:function(){var t=(()=>{for(var t=0,e=0,n=d.length;e<n;++e)for(var r,i,o=d[e],a=1,l=o.length,u=o[0],s=u[0],c=u[1];a<l;++a)r=s,i=c,u=o[a],s=u[0],c=u[1],i<=w?w<c&&(c-i)*(m-r)<(s-r)*(w-i)&&++t:c<=w&&(s-r)*(w-i)<(c-i)*(m-r)&&--t;return t})(),e=g&&t,n=(i=A(i)).length;(e||n)&&(r.polygonStart(),e&&(r.lineStart(),b(null,null,1,r),r.lineEnd()),n&&ut(i,E,t,b,r),r.polygonEnd());h=r,i=d=o=null}};function n(t,e){x(t,e)&&h.point(t,e)}function v(t,e){var n,r,i=x(t,e);d&&o.push([t,e]),p?(a=t,l=e,p=!1,(u=i)&&(h.lineStart(),h.point(t,e))):i&&f?h.point(t,e):((t,e,n,r,i,o)=>{var a=t[0],l=t[1],u=0,s=1,c=e[0]-a,d=e[1]-l,n=n-a;if(c||!(0<n)){if(n/=c,c<0){if(n<u)return;n<s&&(s=n)}else if(0<c){if(s<n)return;u<n&&(u=n)}if(n=i-a,c||!(n<0)){if(n/=c,c<0){if(s<n)return;u<n&&(u=n)}else if(0<c){if(n<u)return;n<s&&(s=n)}if(n=r-l,d||!(0<n)){if(n/=d,d<0){if(n<u)return;n<s&&(s=n)}else if(0<d){if(s<n)return;u<n&&(u=n)}if(n=o-l,d||!(n<0)){if(n/=d,d<0){if(s<n)return;u<n&&(u=n)}else if(0<d){if(n<u)return;n<s&&(s=n)}return 0<u&&(t[0]=a+u*c,t[1]=l+u*d),s<1&&(e[0]=a+s*c,e[1]=l+s*d),1}}}}})(n=[s=Math.max(ct,Math.min(C,s)),c=Math.max(ct,Math.min(C,c))],r=[t=Math.max(ct,Math.min(C,t)),e=Math.max(ct,Math.min(C,e))],m,y,S,w)?(f||(h.lineStart(),h.point(n[0],n[1])),h.point(r[0],r[1]),i||h.lineEnd(),g=!1):i&&(h.lineStart(),h.point(t,e),g=!1),s=t,c=e,f=i}return e}}var ft=t();t();function pt(t){return t}var gt,ht,vt,mt,yt=t(),St=t(),u={point:r,lineStart:r,lineEnd:r,polygonStart:function(){u.lineStart=wt,u.lineEnd=Et},polygonEnd:function(){u.lineStart=u.lineEnd=u.point=r,yt.add(j(St)),St.reset()},result:function(){var t=yt/2;return yt.reset(),t}};function wt(){u.point=xt}function xt(t,e){u.point=bt,gt=vt=t,ht=mt=e}function bt(t,e){St.add(mt*t-vt*e),vt=t,mt=e}function Et(){bt(gt,ht)}var i=1/0,Ct=i,a=-i,Dt=a,_t={point:function(t,e){t<i&&(i=t);a<t&&(a=t);e<Ct&&(Ct=e);Dt<e&&(Dt=e)},lineStart:r,lineEnd:r,polygonStart:r,polygonEnd:r,result:function(){var t=[[i,Ct],[a,Dt]];return a=Dt=-(Ct=i=1/0),t}};var Mt,Pt,s,c,Nt=0,Bt=0,d=0,Ot=0,Ft=0,f=0,Lt=0,jt=0,p=0,h={point:v,lineStart:kt,lineEnd:Tt,polygonStart:function(){h.lineStart=Ut,h.lineEnd=At},polygonEnd:function(){h.point=v,h.lineStart=kt,h.lineEnd=Tt},result:function(){var t=p?[Lt/p,jt/p]:f?[Ot/f,Ft/f]:d?[Nt/d,Bt/d]:[NaN,NaN];return Nt=Bt=d=Ot=Ft=f=Lt=jt=p=0,t}};function v(t,e){Nt+=t,Bt+=e,++d}function kt(){h.point=It}function It(t,e){h.point=Rt,v(s=t,c=e)}function Rt(t,e){var n=t-s,r=e-c,n=I(n*n+r*r);Ot+=n*(s+t)/2,Ft+=n*(c+e)/2,f+=n,v(s=t,c=e)}function Tt(){h.point=v}function Ut(){h.point=zt}function At(){Vt(Mt,Pt)}function zt(t,e){h.point=Vt,v(Mt=s=t,Pt=c=e)}function Vt(t,e){var n=t-s,r=e-c,n=I(n*n+r*r);Ot+=n*(s+t)/2,Ft+=n*(c+e)/2,f+=n,Lt+=(n=c*t-s*e)*(s+t),jt+=n*(c+e),p+=3*n,v(s=t,c=e)}function Gt(t){this._context=t}Gt.prototype={_radius:4.5,pointRadius:function(t){return this._radius=t,this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){0===this._line&&this._context.closePath(),this._point=NaN},point:function(t,e){switch(this._point){case 0:this._context.moveTo(t,e),this._point=1;break;case 1:this._context.lineTo(t,e);break;default:this._context.moveTo(t+this._radius,e),this._context.arc(t,e,this._radius,0,O)}},result:r};var qt,Ht,Wt,m,y,Kt=t(),x={point:r,lineStart:function(){x.point=Yt},lineEnd:function(){qt&&Zt(Ht,Wt),x.point=r},polygonStart:function(){qt=!0},polygonEnd:function(){qt=null},result:function(){var t=+Kt;return Kt.reset(),t}};function Yt(t,e){x.point=Zt,Ht=m=t,Wt=y=e}function Zt(t,e){m-=t,y-=e,Kt.add(I(m*m+y*y)),m=t,y=e}function Xt(){this._string=[]}function Jt(t){return"m0,"+t+"a"+t+","+t+" 0 1,1 0,"+-2*t+"a"+t+","+t+" 0 1,1 0,"+2*t+"z"}function Qt(e,n){var r,i,o=4.5;function a(t){return t&&("function"==typeof o&&i.pointRadius(+o.apply(this,arguments)),l(t,r(i))),i.result()}return a.area=function(t){return l(t,r(u)),u.result()},a.measure=function(t){return l(t,r(x)),x.result()},a.bounds=function(t){return l(t,r(_t)),_t.result()},a.centroid=function(t){return l(t,r(h)),h.result()},a.projection=function(t){return arguments.length?(r=null==t?(e=null,pt):(e=t).stream,a):e},a.context=function(t){return arguments.length?(i=null==t?(n=null,new Xt):new Gt(n=t),"function"!=typeof o&&i.pointRadius(o),a):n},a.pointRadius=function(t){return arguments.length?(o="function"==typeof t?t:(i.pointRadius(+t),+t),a):o},a.projection(e).context(n)}function $t(y,S,w,x){return function(r,l){var u,s,c,n=S(l),e=r.invert(x[0],x[1]),d=ot(),f=S(d),p=!1,i={point:o,lineStart:a,lineEnd:g,polygonStart:function(){i.point=h,i.lineStart=v,i.lineEnd=m,s=[],u=[]},polygonEnd:function(){i.point=o,i.lineStart=a,i.lineEnd=g,s=A(s);var t=((t,e)=>{var n=e[0],r=e[1],i=[P(n),-M(n),0],o=0,a=0;ft.reset();for(var l=0,u=t.length;l<u;++l)if(c=(s=t[l]).length)for(var s,c,d=s[c-1],f=d[0],p=d[1]/2+V,g=P(p),h=M(p),v=0;v<c;++v,f=y,g=w,h=S,d=m){var m=s[v],y=m[0],S=m[1]/2+V,w=P(S),S=M(S),x=y-f,b=0<=x?1:-1,E=b*x,C=_<E,D=g*w;ft.add(k(D*b*P(E),h*S+D*M(E))),o+=C?x+b*O:x,C^n<=f^n<=y&&(Q(D=N(T(d),T(m))),Q(E=N(i,D)),(b=(C^0<=x?-1:1)*R(E[2]))<r||r===b&&(D[0]||D[1]))&&(a+=C^0<=x?1:-1)}return(o<-B||o<B&&ft<-B)^1&a})(u,e);s.length?(p||(l.polygonStart(),p=!0),ut(s,ee,t,w,l)):t&&(p||(l.polygonStart(),p=!0),l.lineStart(),w(null,null,1,l),l.lineEnd()),p&&(l.polygonEnd(),p=!1),s=u=null},sphere:function(){l.polygonStart(),l.lineStart(),w(null,null,1,l),l.lineEnd(),l.polygonEnd()}};function o(t,e){var n=r(t,e);y(t=n[0],e=n[1])&&l.point(t,e)}function t(t,e){t=r(t,e);n.point(t[0],t[1])}function a(){i.point=t,n.lineStart()}function g(){i.point=o,n.lineEnd()}function h(t,e){c.push([t,e]);t=r(t,e);f.point(t[0],t[1])}function v(){f.lineStart(),c=[]}function m(){h(c[0][0],c[0][1]),f.lineEnd();var t,e,n,r,i=f.clean(),o=d.result(),a=o.length;if(c.pop(),u.push(c),c=null,a)if(1&i){if(0<(e=(n=o[0]).length-1)){for(p||(l.polygonStart(),p=!0),l.lineStart(),t=0;t<e;++t)l.point((r=n[t])[0],r[1]);l.lineEnd()}}else 1<a&&2&i&&o.push(o.pop().concat(o.shift())),s.push(o.filter(te))}return i}}function te(t){return 1<t.length}function ee(t,e){return((t=t.x)[0]<0?t[1]-g-B:g-t[1])-((e=e.x)[0]<0?e[1]-g-B:g-e[1])}Xt.prototype={_circle:Jt(4.5),pointRadius:function(t){return this._circle=Jt(t),this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){0===this._line&&this._string.push("Z"),this._point=NaN},point:function(t,e){switch(this._point){case 0:this._string.push("M",t,",",e),this._point=1;break;case 1:this._string.push("L",t,",",e);break;default:this._string.push("M",t,",",e,this._circle)}},result:function(){var t;if(this._string.length)return t=this._string.join(""),this._string=[],t}};var ne=$t(function(){return 1},function(s){var c,d=NaN,f=NaN,p=NaN;return{lineStart:function(){s.lineStart(),c=1},point:function(t,e){var n,r,i,o,a,l=0<t?_:-_,u=j(t-d);j(u-_)<B?(s.point(d,f=0<(f+e)/2?g:-g),s.point(p,f),s.lineEnd(),s.lineStart(),s.point(l,f),s.point(t,f),c=0):p!==l&&_<=u&&(j(d-p)<B&&(d-=p*B),j(t-l)<B&&(t-=l*B),u=f,i=e,a=P((n=d)-(r=t)),f=j(a)>B?G((P(u)*(o=M(i))*P(r)-P(i)*(r=M(u))*P(n))/(r*o*a)):(u+i)/2,s.point(p,f),s.lineEnd(),s.lineStart(),s.point(l,f),c=0),s.point(d=t,f=e),p=l},lineEnd:function(){s.lineEnd(),d=f=NaN},clean:function(){return 2-c}}},function(t,e,n,r){var i;null==t?(i=n*g,r.point(-_,i),r.point(0,i),r.point(_,i),r.point(_,0),r.point(_,-i),r.point(0,-i),r.point(-_,-i),r.point(-_,0),r.point(-_,i)):j(t[0]-e[0])>B?(t=t[0]<e[0]?_:-_,i=n*t/2,r.point(-t,i),r.point(0,i),r.point(t,i)):r.point(e[0],e[1])},[-_,-g]);function re(p,g){var h=M(p),d=0<h,f=j(h)>B;function v(t,e){return M(t)*M(e)>h}function m(t,e,n){var r,i,o,a,l,u,s,c=[1,0,0],d=N(T(t),T(e)),f=S(d,d),p=d[0],g=f-p*p;return g?(r=N(c,d),J(c=w(c,h*f/g),w(d,-h*p/g)),(g=(d=S(c,f=r))*d-(p=S(f,f))*(S(c,c)-1))<0?void 0:(J(g=w(f,(-d-(r=I(g)))/p),c),g=X(g),n?(i=t[0],o=e[0],a=t[1],e=e[1],o<i&&(s=i,i=o,o=s),!(u=j((l=o-i)-_)<B)&&e<a&&(s=a,a=e,e=s),(u||l<B?u?0<a+e^g[1]<(j(g[0]-i)<B?a:e):a<=g[1]&&g[1]<=e:_<l^(i<=g[0]&&g[0]<=o))?(J(s=w(f,(-d+r)/p),c),[g,X(s)]):void 0):g)):!n&&t}function y(t,e){var n=d?p:_-p,r=0;return t<-n?r|=1:n<t&&(r|=2),e<-n?r|=4:n<e&&(r|=8),r}return $t(v,function(o){var a,l,u,s,c;return{lineStart:function(){s=u=!1,c=1},point:function(t,e){var n,r=[t,e],i=v(t,e),t=d?i?0:y(t,e):i?y(t+(t<0?_:-_),e):0;!a&&(s=u=i)&&o.lineStart(),i!==u&&(n=m(a,r),at(a,n)||at(r,n))&&(r[0]+=B,r[1]+=B,i=v(r[0],r[1])),i!==u?(c=0,i?(o.lineStart(),n=m(r,a),o.point(n[0],n[1])):(n=m(a,r),o.point(n[0],n[1]),o.lineEnd()),a=n):f&&a&&d^i&&(t&l||!(e=m(r,a,!0))||(c=0,d?(o.lineStart(),o.point(e[0][0],e[0][1]),o.point(e[1][0],e[1][1]),o.lineEnd()):(o.point(e[1][0],e[1][1]),o.lineEnd(),o.lineStart(),o.point(e[0][0],e[0][1])))),!i||a&&at(a,r)||o.point(r[0],r[1]),a=r,u=i,l=t},lineEnd:function(){u&&o.lineEnd(),a=null},clean:function(){return c|(s&&u)<<1}}},function(t,e,n,r){var i=r,r=p,o=g,a=n,n=t,l=e;if(o){var u=M(r),s=P(r),c=a*o;null==n?(n=r+a*O,l=r-c/2):(n=it(u,n),l=it(u,l),(0<a?n<l:l<n)&&(n+=a*O));for(var d,f=n;0<a?l<f:f<l;f-=c)d=X([u,-s*M(f),-s*P(f)]),i.point(d[0],d[1])}},d?[0,-p]:[-_,p-_])}function ie(r){return function(t){var e,n=new oe;for(e in r)n[e]=r[e];return n.stream=t,n}}function oe(){}function ae(t,e,n){var r=e[1][0]-e[0][0],i=e[1][1]-e[0][1],o=t.clipExtent&&t.clipExtent(),n=(t.scale(150).translate([0,0]),null!=o&&t.clipExtent(null),l(n,t.stream(_t)),_t.result()),a=Math.min(r/(n[1][0]-n[0][0]),i/(n[1][1]-n[0][1])),r=+e[0][0]+(r-a*(n[1][0]+n[0][0]))/2,e=+e[0][1]+(i-a*(n[1][1]+n[0][1]))/2;return null!=o&&t.clipExtent(o),t.scale(150*a).translate([r,e])}oe.prototype={constructor:oe,point:function(t,e){this.stream.point(t,e)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};var le=16,ue=M(30*L);function se(t,e){return+e?(M=t,P=e,function(r){var n,i,o,a,l,u,s,c,d,f,p,g,h={point:t,lineStart:e,lineEnd:m,polygonStart:function(){r.polygonStart(),h.lineStart=y},polygonEnd:function(){r.polygonEnd(),h.lineStart=e}};function t(t,e){t=M(t,e),r.point(t[0],t[1])}function e(){c=NaN,h.point=v,r.lineStart()}function v(t,e){var n=T([t,e]),e=M(t,e);N(c,d,s,f,p,g,c=e[0],d=e[1],s=t,f=n[0],p=n[1],g=n[2],le,r),r.point(c,d)}function m(){h.point=t,r.lineEnd()}function y(){e(),h.point=S,h.lineEnd=w}function S(t,e){v(n=t,e),i=c,o=d,a=f,l=p,u=g,h.point=v}function w(){N(c,d,s,f,p,g,i,o,n,a,l,u,le,r),h.lineEnd=m,m()}return h}):(n=t,ie({point:function(t,e){t=n(t,e),this.stream.point(t[0],t[1])}}));var n,M,P;function N(t,e,n,r,i,o,a,l,u,s,c,d,f,p){var g,h,v,m,y,S,w,x,b,E,C=a-t,D=l-e,_=C*C+D*D;4*P<_&&f--&&(v=o+d,w=R(v/=m=I((g=r+s)*g+(h=i+c)*h+v*v)),y=j(j(v)-1)<B||j(n-u)<B?(n+u)/2:k(h,g),S=(w=M(y,w))[0],P<(E=D*(x=S-t)-C*(b=(w=w[1])-e))*E/_||.3<j((C*x+D*b)/_-.5)||r*s+i*c+o*d<ue)&&(N(t,e,n,r,i,o,S,w,y,g/=m,h/=m,v,f,p),p.point(S,w),N(S,w,y,g,h,v,a,l,u,s,c,d,f,p))}}var ce=ie({point:function(t,e){this.stream.point(t*L,e*L)}});function de(t){var r,i,o,a,l,e,n,u,s,c,d=150,f=480,p=250,g=0,h=0,v=0,m=0,y=0,S=null,w=ne,x=null,b=pt,E=.5,C=se(M,E);function D(t){return[(t=l(t[0]*L,t[1]*L))[0]*d+i,o-t[1]*d]}function _(t){return(t=l.invert((t[0]-i)/d,(o-t[1])/d))&&[t[0]*F,t[1]*F]}function M(t,e){return[(t=r(t,e))[0]*d+i,o-t[1]*d]}function P(){l=$((n=v,t=m,e=y,a=(n%=O)?t||e?$(nt(n),rt(t,e)):nt(n):t||e?rt(t,e):tt),r);var t,e,n=r(g,h);return i=f-n[0]*d,o=p+n[1]*d,N()}function N(){return s=c=null,D}return D.stream=function(t){return s&&c===t?s:s=ce(w(a,C(b(c=t))))},D.clipAngle=function(t){return arguments.length?(w=+t?re(S=t*L,6*L):(S=null,ne),N()):S*F},D.clipExtent=function(t){return arguments.length?(b=null==t?(x=e=n=u=null,pt):dt(x=+t[0][0],e=+t[0][1],n=+t[1][0],u=+t[1][1]),N()):null==x?null:[[x,e],[n,u]]},D.scale=function(t){return arguments.length?(d=+t,P()):d},D.translate=function(t){return arguments.length?(f=+t[0],p=+t[1],P()):[f,p]},D.center=function(t){return arguments.length?(g=t[0]%360*L,h=t[1]%360*L,P()):[g*F,h*F]},D.rotate=function(t){return arguments.length?(v=t[0]%360*L,m=t[1]%360*L,y=2<t.length?t[2]%360*L:0,P()):[v*F,m*F,y*F]},D.precision=function(t){return arguments.length?(C=se(M,E=t*t),N()):I(E)},D.fitExtent=function(t,e){return ae(D,t,e)},D.fitSize=function(t,e){return ae(D,[[0,0],t],e)},function(){return r=t.apply(this,arguments),D.invert=r.invert&&_,P()}}function fe(t,e){var n,r,i,o=P(t),a=(o+P(e))/2;return j(a)<B?(n=M(t),l.invert=function(t,e){return[t/n,R(e*n)]},l):(i=I(r=1+o*(2*a-o))/a,u.invert=function(t,e){e=i-e;return[k(t,j(e))/a*H(e),R((r-(t*t+e*e)*a*a)/(2*a))]},u);function l(t,e){return[t*n,P(e)/n]}function u(t,e){e=I(r-2*a*P(e))/a;return[e*P(t*=a),i-e*M(t)]}}function pe(){return e=0,n=_/3,(t=(r=de(t=fe))(e,n)).parallels=function(t){return arguments.length?r(e=t[0]*L,n=t[1]*L):[e*F,n*F]},t.scale(155.424).center([0,33.6442]);var t,e,n,r}function ge(t){return t}function he(t,e){var p,g,n=e.id,r=e.bbox,i=null==e.properties?{}:e.properties,t=(p=(t=>{var o,a,l,u,s,c;return null==t?ge:(l=t.scale[0],u=t.scale[1],s=t.translate[0],c=t.translate[1],function(t,e){e||(o=a=0);var n=2,r=t.length,i=new Array(r);for(i[0]=(o+=t[0])*l+s,i[1]=(a+=t[1])*u+c;n<r;)i[n]=t[n],++n;return i})})(t.transform),g=t.arcs,function t(e){var n,r=e.type;switch(r){case"GeometryCollection":return{type:r,geometries:e.geometries.map(t)};case"Point":n=o(e.coordinates);break;case"MultiPoint":n=e.coordinates.map(o);break;case"LineString":n=a(e.arcs);break;case"MultiLineString":n=e.arcs.map(a);break;case"Polygon":n=u(e.arcs);break;case"MultiPolygon":n=e.arcs.map(u);break;default:return null}return{type:r,coordinates:n}}(e));function o(t){return p(t)}function a(t){for(var e=[],n=0,r=t.length;n<r;++n){f=d=s=c=u=l=a=o=i=void 0;var i=t[n],o=e;o.length&&o.pop();for(var a=g[i<0?~i:i],l=0,u=a.length;l<u;++l)o.push(p(a[l],l));if(i<0)for(var s,c=o,i=u,d=c.length,f=d-i;f<--d;)s=c[f],c[f++]=c[d],c[d]=s}return e.length<2&&e.push(e[0]),e}function l(t){for(var e=a(t);e.length<4;)e.push(e[0]);return e}function u(t){return t.map(l)}return null==n&&null==r?{type:"Feature",properties:i,geometry:t}:null==r?{type:"Feature",id:n,properties:i,geometry:t}:{type:"Feature",id:n,bbox:r,properties:i,geometry:t}}var ve;(function(t){function o(t,e,n){return t instanceof Array?(t.push(n),t[t.length-1]):t instanceof Object?(t[e]=n,t[e]):void 0}t.exports=function(t){var e=t instanceof Array?[]:{};return function t(e,n){for(var r in e){var i=e[r];i instanceof Array?t(i,o(n,r,[])):i instanceof Object&&"function"!=typeof i?t(i,o(n,r,{})):o(n,r,i)}}(t,e),e}})(ve={exports:{}});b.cartogram=function(){var T=8,U=pe().parallels([29.5,45.5]).scale(1070).translate([480,250]).rotate([96,0]).center([-.6,38.7]),A=function(t){return{}},z=function(t){return 1};function n(e,t){e=V(e);for(var n,r,i,o=G(e.transform),a=e.arcs.length,l=0,u=new Array(a);l<a;){for(y=e.arcs[l].length,S=r=n=0,i=new Array(y);S<y;)e.arcs[l][S][0]=n+=e.arcs[l][S][0],e.arcs[l][S][1]=r+=e.arcs[l][S][1],i[S]=null===U?o(e.arcs[l][S]):U(o(e.arcs[l][S])),S++;u[l++]=i}var p,s,c=Qt().projection(null),d=(p=u,s={LineString:f,MultiLineString:g,Polygon:g,MultiPolygon:function(t){return t.map(g)}},("GeometryCollection"===(t={type:"GeometryCollection",geometries:t}).type?((t=Object.create(t)).geometries=t.geometries.map(h),t):h(t)).geometries.map(function(t){return{type:"Feature",id:t.id,properties:A.call(null,t,e),geometry:t}}));function f(t){for(var e=[],n=0,r=t.length;n<r;++n){f=d=s=c=u=l=a=o=i=void 0;var i=t[n],o=e;o.length&&o.pop();for(var a=p[i<0?~i:i],l=0,u=a.length;l<u;++l)o.push(a[l]);if(i<0)for(var s,c=o,i=u,d=c.length,f=d-i;f<--d;)s=c[f],c[f++]=c[d],c[d]=s}return e}function g(t){return t.map(f)}function h(t){return(t=Object.create(t)).coordinates=s[t.type](t.arcs),t}var v=d.map(z),m=q(v);if(T<=0)return d;for(var I=0;I++<T;){for(var y,S,w,x,b,E,C,D,_,M,P,N,B=d.map(c.area),R=q(B),O=0,F=0,L=d.map(function(t,e){var n=Math.abs(B[e]),e=+v[e],r=R*e/m,i=Math.sqrt(n/Math.PI),o=Math.sqrt(r/Math.PI)-i,a=Math.max(n,r)/Math.min(n,r);return O+=a,F++,{id:t.id,area:n,centroid:c.centroid(t),value:e,desired:r,radius:i,mass:o,sizeError:a}}),j=O/F,k=1/(1+j),a=u.length,l=0;l<a;){for(y=u[l].length,S=0;S<y;){for(w=[0,0],x=L.length,b=0;b<x;)_=L[b].centroid,N=L[b].mass,C=(E=L[b].radius)*E,D=u[l][S][0]-_[0],_=u[l][S][1]-_[1],M=D*D+_*_,P=Math.sqrt(M),w[0]+=(N=E<P?N*E/P:N*(M/C)*(4-3*P/E))*(M=_,0===(C=D)?0:(M=M/C,0<C?1/Math.sqrt(1+M*M):-1/Math.sqrt(1+M*M))),w[1]+=N*(P=_,0===(E=D)?1:(P=P/E,0<E?P/Math.sqrt(1+P*P):-P/Math.sqrt(1+P*P))),b++;u[l][S][0]+=w[0]*k,u[l][S][1]+=w[1]*k,S++}l++}if(j<=1)break}return{features:d,arcs:u}}function V(t){{if(t instanceof Array)return t.map(V);if("string"==typeof t||"number"==typeof t)return t;var e=t,n,r={};for(n in e)r[n]=V(e[n]);return r}}function e(t){return function(){return t}}n.path=Qt().projection(null),n.iterations=function(t){return arguments.length?(T=t,n):T},n.value=function(t){return arguments.length?(z="function"==typeof t?t:e(t),n):z},n.projection=function(t){return arguments.length?(U=t,n):U},n.feature=function(t,e){return{type:"Feature",id:e.id,properties:A.call(null,e,t),geometry:{type:e.type,coordinates:(n=t,("GeometryCollection"===(t=e).type?{type:"FeatureCollection",features:t.geometries.map(function(t){return he(n,t)})}:he(n,t)).geometry.coordinates)}};var n},n.features=function(e,t){return t.map(function(t){return n.feature(e,t)})},n.properties=function(t){return arguments.length?(A="function"==typeof t?t:e(t),n):A};var G=n.transformer=function(t){var e=t.scale[0],n=t.scale[1],r=t.translate[0],i=t.translate[1];function o(t){return[t[0]*e+r,t[1]*n+i]}return o.invert=function(t){return[(t[0]-r)/e,(t[1]-i)/n]},o};return n},Object.defineProperty(b,"__esModule",{value:!0})}),document.createElementNS||(fallbackForm=document.querySelector("form"))&&(fallbackForm.style.display="none");var fallbackForm,rawData,KEY_COLUMN="都道府県",MAX_FILE_SIZE=2097152,PREVIEW_ROW_COUNT=6,CURRENT_PREVIEW_ROW_COUNT=12,DEFAULT_COLOR_SCHEME_ID="blues",COLOR_SCHEMES=[{id:"blues",name:"Blues",interpolator:d3.interpolateBlues},{id:"greens",name:"Greens",interpolator:d3.interpolateGreens},{id:"oranges",name:"Oranges",interpolator:d3.interpolateOranges},{id:"purples",name:"Purples",interpolator:d3.interpolatePurples},{id:"reds",name:"Reds",interpolator:d3.interpolateReds},{id:"viridis",name:"Viridis",interpolator:d3.interpolateViridis},{id:"inferno",name:"Inferno",interpolator:d3.interpolateInferno},{id:"magma",name:"Magma",interpolator:d3.interpolateMagma},{id:"plasma",name:"Plasma",interpolator:d3.interpolatePlasma},{id:"cividis",name:"Cividis",interpolator:d3.interpolateCividis},{id:"turbo",name:"Turbo",interpolator:d3.interpolateTurbo}],fields=[],fieldsById=d3.map(),field=null,pendingDataset=null,originalData=null,isInitialized=!1,currentColorScheme=getColorSchemeById(DEFAULT_COLOR_SCHEME_ID),currentLegendCells=5,body=d3.select("body"),stat=d3.select("#status"),fileInput=d3.select("#file-input"),dropzone=d3.select("#dropzone"),uploadStatus=d3.select("#upload-status"),preview=d3.select("#preview"),previewTable=d3.select("#preview-table"),previewStats=d3.select("#preview-stats"),applyButton=d3.select("#apply-data"),resetButton=d3.select("#reset-data"),currentDataLabel=d3.select("#current-data-label"),currentDataPreview=d3.select("#current-data-preview"),toggleCurrentPreviewButton=d3.select("#toggle-current-preview"),downloadSvgButton=d3.select("#download-svg-btn"),downloadPngButton=d3.select("#download-png-btn"),colorSchemeSelect=d3.select("#color-scheme"),legendCellsSelect=d3.select("#legend-cells"),applyButtonDefaultText=applyButton.text(),applyButtonAppliedText="適用済み",currentPreviewVisible=!0,currentDatasetName="サンプルデータ";function resetFileInputValue(){var t=fileInput.node();t&&(t.value="",t.value)&&(t.type="text",t.type="file")}function shouldBypassDropzoneClick(t){return!!(t&&t.target&&((t=t.target)===fileInput.node()||t.closest&&t.closest(".file-input-label")))}function initializeColorSchemeOptions(){var t=colorSchemeSelect.selectAll("option").data(COLOR_SCHEMES,function(t){return t.id});t.enter().append("option").merge(t).attr("value",function(t){return t.id}).text(function(t){return t.name}),colorSchemeSelect.on("change",function(){setColorScheme(this.value)}),setColorScheme(currentColorScheme&&currentColorScheme.id,{silent:!0})}function setColorScheme(t,e){var t=getColorSchemeById(t)||COLOR_SCHEMES[0],n=!currentColorScheme||currentColorScheme.id!==t.id;currentColorScheme=t,colorSchemeSelect.property("value",currentColorScheme.id),!n||e&&e.silent||field&&"none"!==field.id&&deferredUpdate()}function getColorSchemeById(t){if(t)for(var e=0;e<COLOR_SCHEMES.length;e++)if(COLOR_SCHEMES[e].id===t)return COLOR_SCHEMES[e];return null}var topology,geometries,fieldSelect=d3.select("#field").on("change",function(){field=fields[this.selectedIndex],updateFieldSelection()}),currentColorScheme=currentColorScheme||COLOR_SCHEMES[0],map=(initializeColorSchemeOptions(),legendCellsSelect.on("change",function(){currentLegendCells=+this.value,field&&"none"!==field.id&&deferredUpdate()}),applyButton.property("disabled",!0),applyButton.text(applyButtonDefaultText),setCurrentDataPreviewDefault(),setUploadStatus("CSV ファイル（UTF-8）をアップロードしてカルトグラムをカスタマイズできます。","info"),fileInput.on("change",function(){var t=this.files&&this.files[0];t&&handleFileUpload(t),resetFileInputValue()}),dropzone.on("dragover",function(){d3.event.preventDefault(),dropzone.classed("dragover",!0)}).on("dragleave",function(){dropzone.classed("dragover",!1)}).on("drop",function(){d3.event.preventDefault(),dropzone.classed("dragover",!1);var t=d3.event,t=t.dataTransfer&&t.dataTransfer.files?t.dataTransfer.files[0]:null;t&&handleFileUpload(t)}).on("click",function(){shouldBypassDropzoneClick(d3.event)||fileInput.node().click()}),toggleCurrentPreviewButton.on("click",function(){currentPreviewVisible=!currentPreviewVisible,toggleCurrentPreviewButton.text(currentPreviewVisible?"表データを隠す":"表データを表示"),currentDataPreview.classed("is-hidden",!currentPreviewVisible),currentPreviewVisible&&renderCurrentDataPreview()}),downloadSvgButton.on("click",downloadCurrentSvg),downloadPngButton.on("click",downloadCurrentPng),applyButton.on("click",applyPendingData),resetButton.on("click",resetToSampleData),d3.select("#map")),layer=map.append("g").attr("id","layer"),states=layer.append("g").attr("id","states").selectAll("path"),legendGroup=map.append("g").attr("id","legend").attr("transform","translate(520, 660)"),proj=d3.geoMercator().center([138,36]).scale(1450).translate([400,400]),dataById={},carto=d3.cartogram().projection(proj).properties(function(t){return dataById.get(t.properties.nam_ja)}).value(function(t){return field&&field.key?+t.properties[field.key]:1});function init(){var t=carto.features(topology,geometries),e=d3.geoPath().projection(proj);(states=states.data(t).enter().append("path").attr("class","state").attr("id",function(t){return t.properties.nam_ja}).attr("fill","#fafafa").attr("d",e)).append("title"),updateFieldSelection(),isInitialized=!0}function reset(){stat.text(""),stat.classed("empty",!0),body.classed("updating",!1),clearLegend();var t=carto.features(topology,geometries),e=d3.geoPath().projection(proj);states.data(t).transition().duration(750).ease(d3.easeLinear).attr("fill","#fafafa").attr("d",e),states.select("title").text(function(t){return t.properties.nam_ja})}function update(){function n(t){return+t.properties[a]}var t,e,r,i,o=Date.now(),a=(body.classed("updating",!0),field.key),l=d3.format(","),u=states.data().map(n).filter(function(t){return!isNaN(t)}).sort(d3.ascending);u.length?(t=u[0],u=u[u.length-1],i=currentColorScheme&&currentColorScheme.interpolator||d3.interpolateBlues,e=d3.scaleSequential().interpolator(i).domain([t,u]),r=d3.scaleLinear().domain([t,u]).range([1,1e3]),carto.value(function(t){t=n(t);return isNaN(t)?1:r(t)}),i=carto(topology,geometries).features,states.data(i).select("title").text(function(t){var e=n(t),e=isNaN(e)?"データなし":l(e);return[t.properties.nam_ja,e].join(": ")}),states.transition().duration(750).ease(d3.easeLinear).attr("fill",function(t){t=n(t);return isNaN(t)?"#f0f0f0":e(t)}).attr("d",carto.path),renderLegend(e,t,u),i=(Date.now()-o)/1e3,stat.text(["calculated in",i.toFixed(1),"seconds"].join(" ")),stat.classed("empty",!1)):stat.text("有効な数値が見つかりません。"),body.classed("updating",!1)}d3.json("data/japan.topojson",function(t){geometries=(topology=t).objects.japan.geometries,d3.csv("data/theme.csv",function(t){originalData=cloneDataset(t),loadDataset(cloneDataset(t),{deferRender:!0,label:"サンプルデータ",isSample:!0,defaultToNone:!0,preserveField:!1}),init()})});var deferredUpdate=(()=>{var t;return function(){return clearTimeout(t),stat.text("calculating..."),t=setTimeout(function(){update.apply(null,arguments)},10)}})();function updateFieldSelection(){var t;field&&(fields.length&&fieldSelect.property("selectedIndex",Math.max(fields.indexOf(field),0)),t="none"===field.id,colorSchemeSelect.property("disabled",t),legendCellsSelect.property("disabled",t),(t?reset:deferredUpdate)())}function loadDataset(t,e){e=e||{},rawData=t||[],dataById=d3.nest().key(function(t){return t[KEY_COLUMN]}).rollup(function(t){return t[0]}).map(rawData);var t=buildFieldsFromData(rawData),n=(fieldsById=buildFieldIndex(fields=t),e.forceFieldKey||(!1===e.preserveField?null:field&&field.key));field=selectDefaultField(t,n,e.defaultToNone),refreshFieldOptions(),updateCurrentDatasetLabel(e.label||"カスタムデータ",e.isSample),renderCurrentDataPreview(),stat.text(""),stat.classed("empty",!0),field&&isInitialized&&!e.deferRender&&updateFieldSelection()}function buildFieldsFromData(t){var r=[{name:"(指標未適用)",id:"none"}];return t&&t.length&&getNumericColumns(t).forEach(function(t,e){var n=t.toLowerCase().replace(/[^a-z0-9]/g,"_")||"field_"+e;r.push({name:t,id:n+"_"+e,key:t})}),r}function buildFieldIndex(t){var e=d3.map();return t.forEach(function(t){e.set(t.id,t)}),e}function refreshFieldOptions(){var t=fieldSelect.selectAll("option").data(fields,function(t){return t.id});t.exit().remove(),t.enter().append("option").merge(t).attr("value",function(t){return t.id}).text(function(t){return t.name}),fields.length&&fieldSelect.property("selectedIndex",Math.max(fields.indexOf(field),0))}function getNumericColumns(t){return t&&t.length?Object.keys(t[0]).filter(function(t){return t!==KEY_COLUMN}).filter(function(e){return t.some(function(t){t=t[e];return null!=t&&""!==t&&!isNaN(+t)})}):[]}function handleFileUpload(n){var t;n&&(n.size>MAX_FILE_SIZE?setUploadStatus("ファイルサイズが大きすぎます（2MB以下にしてください）。","danger"):(setUploadStatus("「"+n.name+"」を読み込み中...","info"),(t=new FileReader).onload=function(t){try{var e=(t.target.result||"").trim();preparePreview(d3.csvParse(e),n.name)}catch(t){console.error(t),setUploadStatus("CSV の解析に失敗しました。ファイル内容を確認してください。","danger"),clearPreview()}},t.onerror=function(){setUploadStatus("ファイルの読み込みに失敗しました。","danger"),clearPreview()},t.readAsText(n,"utf-8")))}function preparePreview(t,e){var e=e||"アップロードしたファイル",n=validateDataset(t);n.valid?(pendingDataset={data:t,filename:e,numericColumns:n.numericColumns},preview.classed("is-hidden",!1),renderPreviewTable(t),renderPreviewStats(t,n.numericColumns),setUploadStatus("「"+e+"」を読み込みました。プレビューを確認して適用してください。","success"),applyButton.property("disabled",!1).text(applyButtonDefaultText)):(setUploadStatus(n.message,"danger"),clearPreview())}function validateDataset(t){return t&&t.length?-1===Object.keys(t[0]).indexOf(KEY_COLUMN)?{valid:!1,message:"CSV に「"+KEY_COLUMN+"」列が含まれていません。"}:(t=getNumericColumns(t)).length?{valid:!0,numericColumns:t}:{valid:!1,message:"数値として扱える列がありません。"}:{valid:!1,message:"データ行が見つかりませんでした。"}}function clearPreview(){pendingDataset=null,preview.classed("is-hidden",!0),previewTable.html("<p class='text-muted'>CSV をアップロードするとここにプレビューが表示されます。</p>"),previewStats.html(""),applyButton.property("disabled",!0).text(applyButtonDefaultText)}function renderPreviewTable(t){renderTableInto(previewTable,t,{rowCount:PREVIEW_ROW_COUNT,emptyMessage:"プレビューできる行がありません。",note:function(t,e){return"先頭 "+t+" 行を表示しています（全 "+e+" 行）。"}})}function renderPreviewStats(i,t){var o;t&&t.length?(o=d3.format(",.2f"),t=t.map(function(e){var t=i.map(function(t){return+t[e]}).filter(function(t){return!isNaN(t)}),n=d3.min(t),r=d3.max(t),t=d3.mean(t);return"<p><strong>"+e+"</strong>：最小 "+o(n)+" ／ 最大 "+o(r)+" ／ 平均 "+o(t)+"</p>"}).join(""),previewStats.html(t)):previewStats.html("")}function setUploadStatus(t,e){var n=["help-text"];e&&n.push("tone-"+e),uploadStatus.attr("class",n.join(" ")).text(t||"")}function renderTableInto(t,e,n){var r,i,o,a;n=n||{},e&&e.length?(r=Object.keys(e[0]),i=Math.min(n.rowCount||e.length,e.length),a=e.slice(0,i),o=r.map(function(t){return"<th>"+t+"</th>"}).join(""),a=a.map(function(e){return"<tr>"+r.map(function(t){t=e[t];return"<td>"+(void 0!==t?t:"")+"</td>"}).join("")+"</tr>"}).join(""),e="function"==typeof n.note?n.note(i,e.length):n.note||"先頭 "+i+" 行を表示しています。",t.html("<table class='data-table'><thead><tr>"+o+"</tr></thead><tbody>"+a+"</tbody></table><p class='text-muted small-text'>"+e+"</p>")):t.html("<p class='text-muted'>"+(n.emptyMessage||"表示できるデータがありません。")+"</p>")}function renderCurrentDataPreview(){rawData&&rawData.length?renderTableInto(currentDataPreview,rawData,{rowCount:CURRENT_PREVIEW_ROW_COUNT,emptyMessage:"現在のデータが読み込まれていません。",note:function(t,e){return"先頭 "+t+" 行（"+currentDatasetName+" ／ 全 "+e+" 行）を表示しています。"}}):currentDataPreview.classed("is-hidden",!currentPreviewVisible).html("<p class='text-muted'>現在のデータが読み込まれていません。</p>")}function updateCurrentDatasetLabel(t,e){currentDatasetName=t,currentDataLabel.attr("class","status-value "+(e?"is-sample":"is-custom")).text(t)}function setCurrentDataPreviewDefault(){currentPreviewVisible=!0,toggleCurrentPreviewButton.text("表データを隠す"),currentDataPreview.classed("is-hidden",!1),renderCurrentDataPreview()}function applyPendingData(){var t;pendingDataset?(t=pendingDataset.filename||"アップロードデータ",loadDataset(cloneDataset(pendingDataset.data),{label:t,isSample:!1,preserveField:!1,defaultToNone:!0}),resetMapVisualState(),setUploadStatus("「"+t+"」を適用しました。","success"),clearPreview(),previewTable.html("<p class='text-success'>アップロードしたデータを適用しました。別のファイルを読み込むこともできます。</p>"),applyButton.text(applyButtonAppliedText),currentPreviewVisible=!1,toggleCurrentPreviewButton.text("表データを表示"),currentDataPreview.classed("is-hidden",!0)):setUploadStatus("適用できるプレビューがありません。新しい CSV をアップロードしてください。","danger")}function resetToSampleData(){originalData&&originalData.length?(loadDataset(cloneDataset(originalData),{label:"サンプルデータ",isSample:!0,defaultToNone:!0,preserveField:!1}),resetMapVisualState(),clearPreview(),previewTable.html("<p class='text-muted'>サンプルデータを表示しています。CSV をアップロードするとここにプレビューが表示されます。</p>"),setUploadStatus("サンプルデータに戻しました。","info")):setUploadStatus("サンプルデータを読み込めません。ページを再読み込みしてください。","danger")}function cloneDataset(t){return(t||[]).map(function(e){var n={};return Object.keys(e).forEach(function(t){n[t]=e[t]}),n})}function downloadCurrentSvg(){var t=document.getElementById("map");t?(t=serializeSvg(t),triggerDownload(new Blob([t],{type:"image/svg+xml;charset=utf-8"}),getDownloadFilename("svg"))):console.warn("SVG が見つかりません。")}function downloadCurrentPng(){var t,n,r,i,e=document.getElementById("map");e?(setButtonLoading(downloadPngButton,!0),t=serializeSvg(e),n=extractSvgDimensions(e),e=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(e),(i=new Image).onload=function(){var t=document.createElement("canvas"),e=(t.width=n.width,t.height=n.height,t.getContext("2d"));e.fillStyle="#ffffff",e.fillRect(0,0,t.width,t.height),e.drawImage(i,0,0),URL.revokeObjectURL(r),t.toBlob(function(t){t&&triggerDownload(t,getDownloadFilename("png")),setButtonLoading(downloadPngButton,!1)},"image/png")},i.onerror=function(t){console.error("PNG 生成中にエラーが発生しました。",t),URL.revokeObjectURL(r),setButtonLoading(downloadPngButton,!1)},i.src=r):console.warn("SVG が見つかりません。")}function serializeSvg(t){var e=t.cloneNode(!0),n=extractSvgDimensions(t),t=t.getAttribute("viewBox"),t=(e.setAttribute("width",n.width),e.setAttribute("height",n.height),t||e.setAttribute("viewBox","0 0 "+n.width+" "+n.height),e.setAttribute("xmlns","http://www.w3.org/2000/svg"),e.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),document.createElement("style")),n=(t.setAttribute("type","text/css"),t.textContent="path.state{stroke:#666;stroke-width:.5;}#legend .legend-title{font-size:12px;font-weight:600;fill:#0f172a;}#legend text{font-size:11px;fill:#5f6c80;}",e.insertBefore(t,e.firstChild),document.createElementNS("http://www.w3.org/2000/svg","rect"));return n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("fill","#ffffff"),e.insertBefore(n,t.nextSibling),'<?xml version="1.0" encoding="UTF-8"?>'+(new XMLSerializer).serializeToString(e)}function extractSvgDimensions(t){var e,n=t.getBoundingClientRect(),r=n&&n.width?n.width:null,i=n&&n.height?n.height:null;return r&&i||(r=parseFloat(t.getAttribute("width")),i=parseFloat(t.getAttribute("height"))),r&&i||(e=t.getAttribute("viewBox"))&&4===(e=e.split(/\s+/)).length&&(r=parseFloat(e[2]),i=parseFloat(e[3])),r&&i||(r=(n=t.getBoundingClientRect()).width,i=n.height),{width:Math.max(1,Math.round(r||800)),height:Math.max(1,Math.round(i||600))}}function triggerDownload(t,e){var t=URL.createObjectURL(t),n=document.createElement("a");n.href=t,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}function getDownloadFilename(t){var e=["japan-cartogram"];return currentDatasetName&&e.push(slugify(currentDatasetName)),field&&field.name&&"none"!==field.id&&e.push(slugify(field.name)),e.filter(Boolean).join("-")+"."+t}function slugify(t){return t?t.toString().trim().replace(/\s+/g,"-").replace(/[^0-9A-Za-z\u3000-\u30FF\u4E00-\u9FFF_-]/g,"").replace(/-+/g,"-"):""}function setButtonLoading(t,e){t.classed("is-loading",e).property("disabled",e)}function resetMapVisualState(){isInitialized&&reset()}function renderLegend(t,e,n){var r,i,o;legendGroup&&"function"==typeof d3.legendColor&&t&&(i=field&&field.name&&"none"!==field.id?field.name:"値",o=d3.format(",.0f"),legendGroup.selectAll("*").remove(),(r=legendGroup.append("g").attr("class","legend-content")).append("text").attr("class","legend-title").attr("x",0).attr("y",0).text(i+"（"+o(e)+" ～ "+o(n)+"）"),i=d3.legendColor().shapeWidth(36).shapeHeight(12).labelFormat(o).orient("horizontal").cells(currentLegendCells).scale(t),r.append("g").attr("class","legend-scale").attr("transform","translate(0,20)").call(i).selectAll("rect.swatch").attr("stroke","#cccccc").attr("stroke-width",1).attr("shape-rendering","crispEdges"),r.selectAll(".legend-scale text").filter(function(){return!d3.select(this).classed("legend-title")}).attr("text-anchor","end").attr("y",38).each(function(){var t=d3.select(this),e=(+t.attr("x")||0)+4;t.attr("x",e).attr("transform","rotate(-40 "+e+" 38)")}),e=r.node()&&r.node().getBBox?r.node().getBBox():null)&&(legendGroup.insert("rect",":first-child").attr("class","legend-background").attr("x",e.x-10).attr("y",e.y-10).attr("width",e.width+20).attr("height",e.height+20).attr("rx",12).attr("ry",12).attr("fill","#ffffff").attr("stroke","#dfe5ef"),n=e.width+20,o=e.height+20,legendGroup.attr("transform","translate("+(780-n)+","+(780-o)+")"))}function clearLegend(){legendGroup&&legendGroup.selectAll("*").remove()}function selectDefaultField(t,e,n){var r;return t&&t.length?(r=null,(r=e?t.find(function(t){return t.key===e}):r)||!n&&t.find(function(t){return"none"!==t.id})||t[0]):null}