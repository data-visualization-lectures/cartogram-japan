document.createElementNS||(fallbackForm=document.querySelector("form"))&&(fallbackForm.style.display="none");var fallbackForm,rawData,KEY_COLUMN="都道府県",MAX_FILE_SIZE=2097152,PREVIEW_ROW_COUNT=6,CURRENT_PREVIEW_ROW_COUNT=12,DEFAULT_COLOR_SCHEME_ID="blues",COLOR_SCHEMES=[{id:"blues",name:"Blues",interpolator:d3.interpolateBlues},{id:"greens",name:"Greens",interpolator:d3.interpolateGreens},{id:"oranges",name:"Oranges",interpolator:d3.interpolateOranges},{id:"purples",name:"Purples",interpolator:d3.interpolatePurples},{id:"reds",name:"Reds",interpolator:d3.interpolateReds},{id:"viridis",name:"Viridis",interpolator:d3.interpolateViridis},{id:"inferno",name:"Inferno",interpolator:d3.interpolateInferno},{id:"magma",name:"Magma",interpolator:d3.interpolateMagma},{id:"plasma",name:"Plasma",interpolator:d3.interpolatePlasma},{id:"cividis",name:"Cividis",interpolator:d3.interpolateCividis},{id:"turbo",name:"Turbo",interpolator:d3.interpolateTurbo}],fields=[],fieldsById=d3.map(),field=null,pendingDataset=null,originalData=null,isInitialized=!1,currentColorScheme=getColorSchemeById(DEFAULT_COLOR_SCHEME_ID),currentLegendCells=5,body=d3.select("body"),stat=d3.select("#status"),fileInput=d3.select("#file-input"),dropzone=d3.select("#dropzone"),uploadStatus=d3.select("#upload-status"),preview=d3.select("#preview"),previewTable=d3.select("#preview-table"),previewStats=d3.select("#preview-stats"),applyButton=d3.select("#apply-data"),resetButton=d3.select("#reset-data"),currentDataLabel=d3.select("#current-data-label"),currentDataPreview=d3.select("#current-data-preview"),toggleCurrentPreviewButton=d3.select("#toggle-current-preview"),downloadSvgButton=d3.select("#download-svg-btn"),downloadPngButton=d3.select("#download-png-btn"),colorSchemeSelect=d3.select("#color-scheme"),legendCellsSelect=d3.select("#legend-cells"),applyButtonDefaultText=applyButton.text(),applyButtonAppliedText="適用済み",currentPreviewVisible=!0,currentDatasetName="サンプルデータ";function resetFileInputValue(){var e=fileInput.node();e&&(e.value="",e.value)&&(e.type="text",e.type="file")}function shouldBypassDropzoneClick(e){return!!(e&&e.target&&((e=e.target)===fileInput.node()||e.closest&&e.closest(".file-input-label")))}function initializeColorSchemeOptions(){var e=colorSchemeSelect.selectAll("option").data(COLOR_SCHEMES,function(e){return e.id});e.enter().append("option").merge(e).attr("value",function(e){return e.id}).text(function(e){return e.name}),colorSchemeSelect.on("change",function(){setColorScheme(this.value)}),setColorScheme(currentColorScheme&&currentColorScheme.id,{silent:!0})}function setColorScheme(e,t){var e=getColorSchemeById(e)||COLOR_SCHEMES[0],n=!currentColorScheme||currentColorScheme.id!==e.id;currentColorScheme=e,colorSchemeSelect.property("value",currentColorScheme.id),!n||t&&t.silent||field&&"none"!==field.id&&deferredUpdate()}function getColorSchemeById(e){if(e)for(var t=0;t<COLOR_SCHEMES.length;t++)if(COLOR_SCHEMES[t].id===e)return COLOR_SCHEMES[t];return null}var topology,geometries,fieldSelect=d3.select("#field").on("change",function(){field=fields[this.selectedIndex],updateFieldSelection()}),currentColorScheme=currentColorScheme||COLOR_SCHEMES[0],map=(initializeColorSchemeOptions(),legendCellsSelect.on("change",function(){currentLegendCells=+this.value,field&&"none"!==field.id&&deferredUpdate()}),applyButton.property("disabled",!0),applyButton.text(applyButtonDefaultText),setCurrentDataPreviewDefault(),setUploadStatus("CSV ファイル（UTF-8）をアップロードしてカルトグラムをカスタマイズできます。","info"),fileInput.on("change",function(){var e=this.files&&this.files[0];e&&handleFileUpload(e),resetFileInputValue()}),dropzone.on("dragover",function(){d3.event.preventDefault(),dropzone.classed("dragover",!0)}).on("dragleave",function(){dropzone.classed("dragover",!1)}).on("drop",function(){d3.event.preventDefault(),dropzone.classed("dragover",!1);var e=d3.event,e=e.dataTransfer&&e.dataTransfer.files?e.dataTransfer.files[0]:null;e&&handleFileUpload(e)}).on("click",function(){shouldBypassDropzoneClick(d3.event)||fileInput.node().click()}),toggleCurrentPreviewButton.on("click",function(){currentPreviewVisible=!currentPreviewVisible,toggleCurrentPreviewButton.text(currentPreviewVisible?"表データを隠す":"表データを表示"),currentDataPreview.classed("is-hidden",!currentPreviewVisible),currentPreviewVisible&&renderCurrentDataPreview()}),downloadSvgButton.on("click",downloadCurrentSvg),downloadPngButton.on("click",downloadCurrentPng),applyButton.on("click",applyPendingData),resetButton.on("click",resetToSampleData),d3.select("#map")),layer=map.append("g").attr("id","layer"),states=layer.append("g").attr("id","states").selectAll("path"),legendGroup=map.append("g").attr("id","legend").attr("transform","translate(520, 660)"),proj=d3.geoMercator().center([138,36]).scale(1450).translate([400,400]),dataById={},carto=d3.cartogram().projection(proj).properties(function(e){return dataById.get(e.properties.nam_ja)}).value(function(e){return field&&field.key?+e.properties[field.key]:1});function init(){var e=carto.features(topology,geometries),t=d3.geoPath().projection(proj);(states=states.data(e).enter().append("path").attr("class","state").attr("id",function(e){return e.properties.nam_ja}).attr("fill","#fafafa").attr("d",t)).append("title"),updateFieldSelection(),isInitialized=!0}function reset(){stat.text(""),stat.classed("empty",!0),body.classed("updating",!1),clearLegend();var e=carto.features(topology,geometries),t=d3.geoPath().projection(proj);states.data(e).transition().duration(750).ease(d3.easeLinear).attr("fill","#fafafa").attr("d",t),states.select("title").text(function(e){return e.properties.nam_ja})}function update(){function n(e){return+e.properties[i]}var e,t,a,r,l=Date.now(),i=(body.classed("updating",!0),field.key),o=d3.format(","),d=states.data().map(n).filter(function(e){return!isNaN(e)}).sort(d3.ascending);d.length?(e=d[0],d=d[d.length-1],r=currentColorScheme&&currentColorScheme.interpolator||d3.interpolateBlues,t=d3.scaleSequential().interpolator(r).domain([e,d]),a=d3.scaleLinear().domain([e,d]).range([1,1e3]),carto.value(function(e){e=n(e);return isNaN(e)?1:a(e)}),r=carto(topology,geometries).features,states.data(r).select("title").text(function(e){var t=n(e),t=isNaN(t)?"データなし":o(t);return[e.properties.nam_ja,t].join(": ")}),states.transition().duration(750).ease(d3.easeLinear).attr("fill",function(e){e=n(e);return isNaN(e)?"#f0f0f0":t(e)}).attr("d",carto.path),renderLegend(t,e,d),r=(Date.now()-l)/1e3,stat.text(["calculated in",r.toFixed(1),"seconds"].join(" ")),stat.classed("empty",!1)):stat.text("有効な数値が見つかりません。"),body.classed("updating",!1)}d3.json("data/japan.topojson",function(e){geometries=(topology=e).objects.japan.geometries,d3.csv("data/theme.csv",function(e){originalData=cloneDataset(e),loadDataset(cloneDataset(e),{deferRender:!0,label:"サンプルデータ",isSample:!0,defaultToNone:!0,preserveField:!1}),init()})});var deferredUpdate=(()=>{var e;return function(){return clearTimeout(e),stat.text("calculating..."),e=setTimeout(function(){update.apply(null,arguments)},10)}})();function updateFieldSelection(){var e;field&&(fields.length&&fieldSelect.property("selectedIndex",Math.max(fields.indexOf(field),0)),e="none"===field.id,colorSchemeSelect.property("disabled",e),legendCellsSelect.property("disabled",e),(e?reset:deferredUpdate)())}function loadDataset(e,t){t=t||{},rawData=e||[],dataById=d3.nest().key(function(e){return e[KEY_COLUMN]}).rollup(function(e){return e[0]}).map(rawData);var e=buildFieldsFromData(rawData),n=(fieldsById=buildFieldIndex(fields=e),t.forceFieldKey||(!1===t.preserveField?null:field&&field.key));field=selectDefaultField(e,n,t.defaultToNone),refreshFieldOptions(),updateCurrentDatasetLabel(t.label||"カスタムデータ",t.isSample),renderCurrentDataPreview(),stat.text(""),stat.classed("empty",!0),field&&isInitialized&&!t.deferRender&&updateFieldSelection()}function buildFieldsFromData(e){var a=[{name:"(指標未適用)",id:"none"}];return e&&e.length&&getNumericColumns(e).forEach(function(e,t){var n=e.toLowerCase().replace(/[^a-z0-9]/g,"_")||"field_"+t;a.push({name:e,id:n+"_"+t,key:e})}),a}function buildFieldIndex(e){var t=d3.map();return e.forEach(function(e){t.set(e.id,e)}),t}function refreshFieldOptions(){var e=fieldSelect.selectAll("option").data(fields,function(e){return e.id});e.exit().remove(),e.enter().append("option").merge(e).attr("value",function(e){return e.id}).text(function(e){return e.name}),fields.length&&fieldSelect.property("selectedIndex",Math.max(fields.indexOf(field),0))}function getNumericColumns(e){return e&&e.length?Object.keys(e[0]).filter(function(e){return e!==KEY_COLUMN}).filter(function(t){return e.some(function(e){e=e[t];return null!=e&&""!==e&&!isNaN(+e)})}):[]}function handleFileUpload(n){var e;n&&(n.size>MAX_FILE_SIZE?setUploadStatus("ファイルサイズが大きすぎます（2MB以下にしてください）。","danger"):(setUploadStatus("「"+n.name+"」を読み込み中...","info"),(e=new FileReader).onload=function(e){try{var t=(e.target.result||"").trim();preparePreview(d3.csvParse(t),n.name)}catch(e){console.error(e),setUploadStatus("CSV の解析に失敗しました。ファイル内容を確認してください。","danger"),clearPreview()}},e.onerror=function(){setUploadStatus("ファイルの読み込みに失敗しました。","danger"),clearPreview()},e.readAsText(n,"utf-8")))}function preparePreview(e,t){var t=t||"アップロードしたファイル",n=validateDataset(e);n.valid?(pendingDataset={data:e,filename:t,numericColumns:n.numericColumns},preview.classed("is-hidden",!1),renderPreviewTable(e),renderPreviewStats(e,n.numericColumns),setUploadStatus("「"+t+"」を読み込みました。プレビューを確認して適用してください。","success"),applyButton.property("disabled",!1).text(applyButtonDefaultText)):(setUploadStatus(n.message,"danger"),clearPreview())}function validateDataset(e){return e&&e.length?-1===Object.keys(e[0]).indexOf(KEY_COLUMN)?{valid:!1,message:"CSV に「"+KEY_COLUMN+"」列が含まれていません。"}:(e=getNumericColumns(e)).length?{valid:!0,numericColumns:e}:{valid:!1,message:"数値として扱える列がありません。"}:{valid:!1,message:"データ行が見つかりませんでした。"}}function clearPreview(){pendingDataset=null,preview.classed("is-hidden",!0),previewTable.html("<p class='text-muted'>CSV をアップロードするとここにプレビューが表示されます。</p>"),previewStats.html(""),applyButton.property("disabled",!0).text(applyButtonDefaultText)}function renderPreviewTable(e){renderTableInto(previewTable,e,{rowCount:PREVIEW_ROW_COUNT,emptyMessage:"プレビューできる行がありません。",note:function(e,t){return"先頭 "+e+" 行を表示しています（全 "+t+" 行）。"}})}function renderPreviewStats(r,e){var l;e&&e.length?(l=d3.format(",.2f"),e=e.map(function(t){var e=r.map(function(e){return+e[t]}).filter(function(e){return!isNaN(e)}),n=d3.min(e),a=d3.max(e),e=d3.mean(e);return"<p><strong>"+t+"</strong>：最小 "+l(n)+" ／ 最大 "+l(a)+" ／ 平均 "+l(e)+"</p>"}).join(""),previewStats.html(e)):previewStats.html("")}function setUploadStatus(e,t){var n=["help-text"];t&&n.push("tone-"+t),uploadStatus.attr("class",n.join(" ")).text(e||"")}function renderTableInto(e,t,n){var a,r,l,i;n=n||{},t&&t.length?(a=Object.keys(t[0]),r=Math.min(n.rowCount||t.length,t.length),i=t.slice(0,r),l=a.map(function(e){return"<th>"+e+"</th>"}).join(""),i=i.map(function(t){return"<tr>"+a.map(function(e){e=t[e];return"<td>"+(void 0!==e?e:"")+"</td>"}).join("")+"</tr>"}).join(""),t="function"==typeof n.note?n.note(r,t.length):n.note||"先頭 "+r+" 行を表示しています。",e.html("<table class='data-table'><thead><tr>"+l+"</tr></thead><tbody>"+i+"</tbody></table><p class='text-muted small-text'>"+t+"</p>")):e.html("<p class='text-muted'>"+(n.emptyMessage||"表示できるデータがありません。")+"</p>")}function renderCurrentDataPreview(){rawData&&rawData.length?renderTableInto(currentDataPreview,rawData,{rowCount:CURRENT_PREVIEW_ROW_COUNT,emptyMessage:"現在のデータが読み込まれていません。",note:function(e,t){return"先頭 "+e+" 行（"+currentDatasetName+" ／ 全 "+t+" 行）を表示しています。"}}):currentDataPreview.classed("is-hidden",!currentPreviewVisible).html("<p class='text-muted'>現在のデータが読み込まれていません。</p>")}function updateCurrentDatasetLabel(e,t){currentDatasetName=e,currentDataLabel.attr("class","status-value "+(t?"is-sample":"is-custom")).text(e)}function setCurrentDataPreviewDefault(){currentPreviewVisible=!0,toggleCurrentPreviewButton.text("表データを隠す"),currentDataPreview.classed("is-hidden",!1),renderCurrentDataPreview()}function applyPendingData(){var e;pendingDataset?(e=pendingDataset.filename||"アップロードデータ",loadDataset(cloneDataset(pendingDataset.data),{label:e,isSample:!1,preserveField:!1,defaultToNone:!0}),resetMapVisualState(),setUploadStatus("「"+e+"」を適用しました。","success"),clearPreview(),previewTable.html("<p class='text-success'>アップロードしたデータを適用しました。別のファイルを読み込むこともできます。</p>"),applyButton.text(applyButtonAppliedText),currentPreviewVisible=!1,toggleCurrentPreviewButton.text("表データを表示"),currentDataPreview.classed("is-hidden",!0)):setUploadStatus("適用できるプレビューがありません。新しい CSV をアップロードしてください。","danger")}function resetToSampleData(){originalData&&originalData.length?(loadDataset(cloneDataset(originalData),{label:"サンプルデータ",isSample:!0,defaultToNone:!0,preserveField:!1}),resetMapVisualState(),clearPreview(),previewTable.html("<p class='text-muted'>サンプルデータを表示しています。CSV をアップロードするとここにプレビューが表示されます。</p>"),setUploadStatus("サンプルデータに戻しました。","info")):setUploadStatus("サンプルデータを読み込めません。ページを再読み込みしてください。","danger")}function cloneDataset(e){return(e||[]).map(function(t){var n={};return Object.keys(t).forEach(function(e){n[e]=t[e]}),n})}function downloadCurrentSvg(){var e=document.getElementById("map");e?(e=serializeSvg(e),triggerDownload(new Blob([e],{type:"image/svg+xml;charset=utf-8"}),getDownloadFilename("svg"))):console.warn("SVG が見つかりません。")}function downloadCurrentPng(){var e,n,a,r,t=document.getElementById("map");t?(setButtonLoading(downloadPngButton,!0),e=serializeSvg(t),n=extractSvgDimensions(t),t=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),a=URL.createObjectURL(t),(r=new Image).onload=function(){var e=document.createElement("canvas"),t=(e.width=n.width,e.height=n.height,e.getContext("2d"));t.fillStyle="#ffffff",t.fillRect(0,0,e.width,e.height),t.drawImage(r,0,0),URL.revokeObjectURL(a),e.toBlob(function(e){e&&triggerDownload(e,getDownloadFilename("png")),setButtonLoading(downloadPngButton,!1)},"image/png")},r.onerror=function(e){console.error("PNG 生成中にエラーが発生しました。",e),URL.revokeObjectURL(a),setButtonLoading(downloadPngButton,!1)},r.src=a):console.warn("SVG が見つかりません。")}function serializeSvg(e){var t=e.cloneNode(!0),n=extractSvgDimensions(e),e=e.getAttribute("viewBox"),e=(t.setAttribute("width",n.width),t.setAttribute("height",n.height),e||t.setAttribute("viewBox","0 0 "+n.width+" "+n.height),t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),document.createElement("style")),n=(e.setAttribute("type","text/css"),e.textContent="path.state{stroke:#666;stroke-width:.5;}#legend .legend-title{font-size:12px;font-weight:600;fill:#0f172a;}#legend text{font-size:11px;fill:#5f6c80;}",t.insertBefore(e,t.firstChild),document.createElementNS("http://www.w3.org/2000/svg","rect"));return n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("fill","#ffffff"),t.insertBefore(n,e.nextSibling),'<?xml version="1.0" encoding="UTF-8"?>'+(new XMLSerializer).serializeToString(t)}function extractSvgDimensions(e){var t,n=e.getBoundingClientRect(),a=n&&n.width?n.width:null,r=n&&n.height?n.height:null;return a&&r||(a=parseFloat(e.getAttribute("width")),r=parseFloat(e.getAttribute("height"))),a&&r||(t=e.getAttribute("viewBox"))&&4===(t=t.split(/\s+/)).length&&(a=parseFloat(t[2]),r=parseFloat(t[3])),a&&r||(a=(n=e.getBoundingClientRect()).width,r=n.height),{width:Math.max(1,Math.round(a||800)),height:Math.max(1,Math.round(r||600))}}function triggerDownload(e,t){var e=URL.createObjectURL(e),n=document.createElement("a");n.href=e,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(e)}function getDownloadFilename(e){var t=["japan-cartogram"];return currentDatasetName&&t.push(slugify(currentDatasetName)),field&&field.name&&"none"!==field.id&&t.push(slugify(field.name)),t.filter(Boolean).join("-")+"."+e}function slugify(e){return e?e.toString().trim().replace(/\s+/g,"-").replace(/[^0-9A-Za-z\u3000-\u30FF\u4E00-\u9FFF_-]/g,"").replace(/-+/g,"-"):""}function setButtonLoading(e,t){e.classed("is-loading",t).property("disabled",t)}function resetMapVisualState(){isInitialized&&reset()}function renderLegend(e,t,n){var a,r,l;legendGroup&&"function"==typeof d3.legendColor&&e&&(r=field&&field.name&&"none"!==field.id?field.name:"値",l=d3.format(",.0f"),legendGroup.selectAll("*").remove(),(a=legendGroup.append("g").attr("class","legend-content")).append("text").attr("class","legend-title").attr("x",0).attr("y",0).text(r+"（"+l(t)+" ～ "+l(n)+"）"),r=d3.legendColor().shapeWidth(36).shapeHeight(12).labelFormat(l).orient("horizontal").cells(currentLegendCells).scale(e),a.append("g").attr("class","legend-scale").attr("transform","translate(0,20)").call(r).selectAll("rect.swatch").attr("stroke","#cccccc").attr("stroke-width",1).attr("shape-rendering","crispEdges"),a.selectAll(".legend-scale text").filter(function(){return!d3.select(this).classed("legend-title")}).attr("text-anchor","end").attr("y",38).each(function(){var e=d3.select(this),t=(+e.attr("x")||0)+4;e.attr("x",t).attr("transform","rotate(-40 "+t+" 38)")}),t=a.node()&&a.node().getBBox?a.node().getBBox():null)&&(legendGroup.insert("rect",":first-child").attr("class","legend-background").attr("x",t.x-10).attr("y",t.y-10).attr("width",t.width+20).attr("height",t.height+20).attr("rx",12).attr("ry",12).attr("fill","#ffffff").attr("stroke","#dfe5ef"),n=t.width+20,l=t.height+20,legendGroup.attr("transform","translate("+(780-n)+","+(780-l)+")"))}function clearLegend(){legendGroup&&legendGroup.selectAll("*").remove()}function selectDefaultField(e,t,n){var a;return e&&e.length?(a=null,(a=t?e.find(function(e){return e.key===t}):a)||!n&&e.find(function(e){return"none"!==e.id})||e[0]):null}